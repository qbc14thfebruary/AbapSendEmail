REPORT ZPG_SEND_MAIL_2.
TABLES: SBOOK.
SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-001.
SELECT-OPTIONS : S_CONNID FOR SBOOK-CONNID,
                 S_BOOKID FOR SBOOK-BOOKID.
PARAMETERS: P_ADDR TYPE ADR6-SMTP_ADDR OBLIGATORY, " email address
            P_SUBJ TYPE STRING .                   "Subject title.
SELECTION-SCREEN END OF BLOCK B1.

TYPES: BEGIN OF GTY_DATA,
         CONNID   TYPE S_CONN_ID,
         FLDATE   TYPE S_DATE,
         BOOKID   TYPE S_BOOK_ID,
         CUSTOMID TYPE S_CUSTOMER,
         CUSTTYPE TYPE S_CUSTTYPE,
         SMOKER   TYPE S_SMOKER,
       END OF GTY_DATA.
DATA: GT_DATA TYPE TABLE OF GTY_DATA,
      GS_DATA TYPE GTY_DATA.

DATA : GT_CONTENTS TYPE STANDARD TABLE OF SOLISTI1,
       GS_CONTENTS TYPE SOLISTI1,
       GV_DOCUMENT TYPE REF TO CL_DOCUMENT_BCS.

CONSTANTS:
**-- Constants used in the body of the Email (HTML)
  C_SPACE(6) TYPE C VALUE '&nbsp;'.

START-OF-SELECTION.
  PERFORM GET_DATA.
  IF GT_DATA[] IS NOT INITIAL.
    PERFORM PROCESS_DATA.
    PERFORM SEND_EMAIL.
  ENDIF.



FORM GET_DATA .
  SELECT CONNID
         FLDATE
         BOOKID
         CUSTOMID
         CUSTTYPE
         SMOKER
   FROM SBOOK
   UP TO 10 ROWS
   INTO TABLE GT_DATA
   WHERE BOOKID IN S_BOOKID AND
         CONNID IN S_CONNID AND
         CARRID = 'AA' .
ENDFORM.

FORM PROCESS_DATA .
  CLEAR : GT_CONTENTS[].

  "email body
  GS_CONTENTS-LINE = '<HTML> <BODY>'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  CONCATENATE '<p style="font-family:Calibri;font-size:15;">' 'Dear Sir / Madam,' INTO GS_CONTENTS-LINE.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  PERFORM LINE_BREAK.
  PERFORM LINE_BREAK.

  CONCATENATE 'We wish to inform you booking details for our project ' 'situated at' INTO GS_CONTENTS-LINE SEPARATED BY SPACE.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  "html body
  GS_CONTENTS-LINE = '<table style="font-family:calibri;font-size:15;MARGIN:10px; width:100%"'.   " bordercolor="blue"'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  GS_CONTENTS-LINE = 'cellspacing="0" cellpadding="1" width="75%" '.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  GS_CONTENTS-LINE = 'border="1"><tbody><tr>'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  GS_CONTENTS-LINE = '<th bgcolor="#C0C0C0">Flight Number</th>'.                    "66CCFF
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  GS_CONTENTS-LINE = '<th bgcolor="#C0C0C0">Booking Date</th>'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.


  GS_CONTENTS-LINE = '<th bgcolor="#C0C0C0">Booking number</th>'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  GS_CONTENTS-LINE = '<th bgcolor="#C0C0C0">Customer Name</th>'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  GS_CONTENTS-LINE = '<th bgcolor="#C0C0C0">B/P customer</th>'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  GS_CONTENTS-LINE = '<th bgcolor="#C0C0C0">Smoker</th>'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  "table content
  LOOP AT GT_DATA INTO GS_DATA.

    GS_CONTENTS-LINE = '<tr align = "center">'.
    APPEND GS_CONTENTS TO GT_CONTENTS.
    CLEAR : GS_CONTENTS.

    CONCATENATE '<td>' GS_DATA-CONNID '</td>' INTO GS_CONTENTS-LINE SEPARATED BY SPACE.
    APPEND GS_CONTENTS TO GT_CONTENTS.
    CLEAR : GS_CONTENTS.

    CONCATENATE '<td>' GS_DATA-FLDATE '</td>' INTO GS_CONTENTS-LINE SEPARATED BY SPACE.
    APPEND GS_CONTENTS TO GT_CONTENTS.
    CLEAR : GS_CONTENTS.

    CONCATENATE '<td>' GS_DATA-BOOKID '</td>' INTO GS_CONTENTS-LINE SEPARATED BY SPACE.
    APPEND GS_CONTENTS TO GT_CONTENTS.
    CLEAR : GS_CONTENTS.

    CONCATENATE '<td>' GS_DATA-CUSTOMID '</td>' INTO GS_CONTENTS-LINE SEPARATED BY SPACE.
    APPEND GS_CONTENTS TO GT_CONTENTS.
    CLEAR : GS_CONTENTS.

    CONCATENATE '<td>' GS_DATA-CUSTTYPE '</td>' INTO GS_CONTENTS-LINE SEPARATED BY SPACE.
    APPEND GS_CONTENTS TO GT_CONTENTS.
    CLEAR : GS_CONTENTS.

    CONCATENATE '<td>' GS_DATA-SMOKER '</td>' INTO GS_CONTENTS-LINE SEPARATED BY SPACE.
    APPEND GS_CONTENTS TO GT_CONTENTS.
    CLEAR : GS_CONTENTS.
  ENDLOOP.

  GS_CONTENTS-LINE = '</tbody> </table>'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  PERFORM LINE_BREAK.
  PERFORM LINE_BREAK.

  GS_CONTENTS-LINE = 'Kindly note:'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  PERFORM LINE_BREAK.

  CONCATENATE C_SPACE C_SPACE C_SPACE C_SPACE '-  this is system generated email' INTO GS_CONTENTS-LINE SEPARATED BY SPACE.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  PERFORM LINE_BREAK.

  CONCATENATE C_SPACE C_SPACE C_SPACE C_SPACE
  '-  status of booking is ‘accepted’ as per the terms of booking form' INTO GS_CONTENTS-LINE SEPARATED BY SPACE.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  PERFORM LINE_BREAK.

  CONCATENATE C_SPACE C_SPACE C_SPACE C_SPACE
  '-  booking confirmation is subject to clearing of cheque / DD and compliance of booking conditions by customers'
  INTO GS_CONTENTS-LINE SEPARATED BY SPACE.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.

  PERFORM LINE_BREAK.
  PERFORM LINE_BREAK.

  GS_CONTENTS-LINE = 'Regards,'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.
  PERFORM LINE_BREAK.

  GS_CONTENTS-LINE = 'QuynhBC'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.
  PERFORM LINE_BREAK.
ENDFORM.

FORM LINE_BREAK .
  GS_CONTENTS-LINE = '<br>'.
  APPEND GS_CONTENTS TO GT_CONTENTS.
  CLEAR : GS_CONTENTS.
ENDFORM.

FORM SEND_EMAIL .
  DATA: LS_CONTENT TYPE SOLISTI1.
  DATA: LS_PACKING_LIST  TYPE SOPCKLSTI1,
        LT_PACKING_LIST  TYPE TABLE OF SOPCKLSTI1,
        LS_DOCUMENT_DATA TYPE SODOCCHGI1.
  DATA: LS_RECEIVER TYPE SOMLRECI1,
        LT_RECEIVER TYPE TABLE OF SOMLRECI1.
  DATA: GV_CONTENT_LINES TYPE I,
        GV_MSG_TEXT      TYPE STRING.

  DESCRIBE TABLE GT_CONTENTS LINES GV_CONTENT_LINES.
* update the packing list.
  LS_PACKING_LIST-TRANSF_BIN = ' '.
  LS_PACKING_LIST-BODY_START = 1.
  LS_PACKING_LIST-BODY_NUM = GV_CONTENT_LINES.
  LS_PACKING_LIST-DOC_TYPE = 'HTM'. "'RAW'.
  APPEND LS_PACKING_LIST TO LT_PACKING_LIST.

  READ TABLE GT_CONTENTS INDEX GV_CONTENT_LINES INTO GS_CONTENTS.
  LS_DOCUMENT_DATA-DOC_SIZE = ( GV_CONTENT_LINES - 1 ) * 255 + STRLEN( GS_DATA ).
  LS_DOCUMENT_DATA-OBJ_NAME  = 'SAPoffice'.
  LS_DOCUMENT_DATA-OBJ_DESCR = P_SUBJ. "mail subject
  LS_DOCUMENT_DATA-OBJ_PRIO = 5.
  LS_DOCUMENT_DATA-PRIORITY = 5.

  LS_RECEIVER-RECEIVER = P_ADDR.
  LS_RECEIVER-REC_TYPE = 'U'.
  LS_RECEIVER-COM_TYPE = 'INT'.
  APPEND LS_RECEIVER TO LT_RECEIVER.

  CALL FUNCTION 'SO_NEW_DOCUMENT_ATT_SEND_API1'
    EXPORTING
      DOCUMENT_DATA              = LS_DOCUMENT_DATA
*     COMMIT_WORK                = 'X'
    TABLES
      PACKING_LIST               = LT_PACKING_LIST
      CONTENTS_TXT               = GT_CONTENTS
      RECEIVERS                  = LT_RECEIVER
    EXCEPTIONS
      TOO_MANY_RECEIVERS         = 1
      DOCUMENT_NOT_SENT          = 2
      DOCUMENT_TYPE_NOT_EXIST    = 3
      OPERATION_NO_AUTHORIZATION = 4
      PARAMETER_ERROR            = 5
      X_ERROR                    = 6
      ENQUEUE_ERROR              = 7
      OTHERS                     = 8.
  IF SY-SUBRC = 0.
    COMMIT WORK.
    MESSAGE 'The program has finished running and go to TCODE: SOST' TYPE 'S'.
  ELSE.
*   keep error message
    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
            INTO GV_MSG_TEXT.
    MESSAGE GV_MSG_TEXT TYPE 'E'.
  ENDIF.
ENDFORM.